<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AYUSH Clinic Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        button:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .card h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card h2 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .results {
            margin-top: 20px;
        }

        .result-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .result-item h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            background: #667eea;
            color: white;
            border-radius: 3px;
            font-size: 12px;
            margin-right: 5px;
        }

        .badge-success {
            background: #28a745;
        }

        .badge-warning {
            background: #ffc107;
            color: #333;
        }

        .badge-danger {
            background: #dc3545;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .problem-list-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .diagnosis-item {
            background: #e7f3ff;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üè• AYUSH Clinic Management System</h1>
        <p class="subtitle">Complete clinic management with NAMASTE-ICD-11 dual coding integration</p>

        <!-- Dashboard Stats -->
        <div id="dashboardStats" class="stats"></div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('patients')">üë• Patients</button>
            <button class="tab" onclick="showTab('appointments')">üìÖ Appointments</button>
            <button class="tab" onclick="showTab('encounters')">üè• Encounters</button>
            <button class="tab" onclick="showTab('prescriptions')">üíä Prescriptions</button>
            <button class="tab" onclick="showTab('billing')">üí∞ Billing</button>
            <button class="tab" onclick="showTab('mapping')">üîó NAMASTE-ICD-11 Mapping</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2>Dashboard Overview</h2>
            <div id="dashboardContent">
                <div class="loading">Loading dashboard statistics...</div>
            </div>
        </div>

        <!-- Patients Tab -->
        <div id="patients" class="tab-content">
            <h2>Patient Management</h2>
            <div class="card">
                <h3>Register New Patient</h3>
                <form id="patientForm" onsubmit="registerPatient(event)">
                    <div class="grid">
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" id="patientName" required>
                        </div>
                        <div class="form-group">
                            <label>Age</label>
                            <input type="number" id="patientAge">
                        </div>
                        <div class="form-group">
                            <label>Gender</label>
                            <select id="patientGender">
                                <option value="">Select</option>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="patientPhone">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="patientEmail">
                        </div>
                        <div class="form-group">
                            <label>ABHA ID</label>
                            <input type="text" id="patientAbha">
                        </div>
                    </div>
                    <button type="submit">Register Patient</button>
                </form>
            </div>
            <div class="card" style="margin-top: 20px;">
                <h3>Search Patients</h3>
                <div class="form-group">
                    <input type="text" id="patientSearch" placeholder="Search by name, phone, or ABHA ID"
                        onkeyup="searchPatients()">
                </div>
                <div id="patientList"></div>
            </div>
        </div>

        <!-- Appointments Tab -->
        <div id="appointments" class="tab-content">
            <h2>Appointment Scheduling</h2>
            <div class="card">
                <h3>Book New Appointment</h3>
                <form id="appointmentForm" onsubmit="bookAppointment(event)">
                    <div class="grid">
                        <div class="form-group">
                            <label>Patient *</label>
                            <select id="appointmentPatient" required>
                                <option value="">Select Patient</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date *</label>
                            <input type="datetime-local" id="appointmentDate" required>
                        </div>
                        <div class="form-group">
                            <label>Reason</label>
                            <textarea id="appointmentReason" rows="3"></textarea>
                        </div>
                    </div>
                    <button type="submit">Book Appointment</button>
                </form>
            </div>
            <div class="card" style="margin-top: 20px;">
                <h3>Today's Appointments</h3>
                <div id="appointmentsList"></div>
            </div>
        </div>

        <!-- Encounters Tab -->
        <div id="encounters" class="tab-content">
            <h2>Patient Encounters (Visits)</h2>
            <div class="card">
                <h3>Create New Encounter</h3>
                <form id="encounterForm" onsubmit="createEncounter(event)">
                    <div class="grid">
                        <div class="form-group">
                            <label>Patient *</label>
                            <select id="encounterPatient" required>
                                <option value="">Select Patient</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Chief Complaint</label>
                            <textarea id="chiefComplaint" rows="3"
                                placeholder="e.g., Jwara (Fever) and Kasa (Cough)"></textarea>
                        </div>
                    </div>
                    <button type="submit">Start Encounter</button>
                </form>
            </div>
            <div id="encounterDetails" style="display: none;">
                <div class="card" style="margin-top: 20px;">
                    <h3>Encounter: <span id="encounterIdDisplay"></span></h3>
                    <div class="form-group">
                        <label>Record Vital Signs</label>
                        <div class="grid">
                            <input type="number" id="vitalTemp" placeholder="Temperature (¬∞C)">
                            <input type="number" id="vitalBP1" placeholder="BP Systolic">
                            <input type="number" id="vitalBP2" placeholder="BP Diastolic">
                            <input type="number" id="vitalPulse" placeholder="Pulse (BPM)">
                            <input type="number" id="vitalWeight" placeholder="Weight (kg)">
                            <input type="number" id="vitalHeight" placeholder="Height (cm)">
                        </div>
                        <button type="button" onclick="recordVitals()" style="margin-top: 10px;">Record Vitals</button>
                    </div>
                </div>
                <div class="card" style="margin-top: 20px;">
                    <h3>Add Diagnosis (NAMASTE-ICD-11 Dual Coding)</h3>
                    <div class="form-group">
                        <label>Enter NAMASTE Term</label>
                        <input type="text" id="namasteTerm" placeholder="e.g., Jwara"
                            onkeyup="if(event.key==='Enter') suggestDiagnosis()">
                        <button type="button" onclick="suggestDiagnosis()" style="margin-top: 10px;">Get ICD-11
                            Suggestions</button>
                    </div>
                    <div id="diagnosisSuggestions"></div>
                    <div id="encounterDiagnoses" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>

        <!-- Prescriptions Tab -->
        <div id="prescriptions" class="tab-content">
            <h2>Prescription Management</h2>
            <div class="card">
                <h3>Create Prescription</h3>
                <form id="prescriptionForm" onsubmit="createPrescription(event)">
                    <div class="grid">
                        <div class="form-group">
                            <label>Patient *</label>
                            <select id="prescriptionPatient" required>
                                <option value="">Select Patient</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Medicine Name *</label>
                            <input type="text" id="medicineName" required>
                        </div>
                        <div class="form-group">
                            <label>Dosage</label>
                            <input type="text" id="medicineDosage" placeholder="e.g., 500mg">
                        </div>
                        <div class="form-group">
                            <label>Frequency</label>
                            <input type="text" id="medicineFrequency" placeholder="e.g., Twice daily">
                        </div>
                        <div class="form-group">
                            <label>Duration</label>
                            <input type="text" id="medicineDuration" placeholder="e.g., 5 days">
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" id="medicineQuantity">
                        </div>
                    </div>
                    <button type="submit">Create Prescription</button>
                </form>
            </div>
        </div>

        <!-- Billing Tab -->
        <div id="billing" class="tab-content">
            <h2>Billing & Invoicing</h2>
            <div class="card">
                <h3>Create Invoice</h3>
                <form id="invoiceForm" onsubmit="createInvoice(event)">
                    <div class="grid">
                        <div class="form-group">
                            <label>Patient *</label>
                            <select id="invoicePatient" required>
                                <option value="">Select Patient</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Item Type</label>
                            <select id="invoiceItemType">
                                <option value="consultation">Consultation</option>
                                <option value="medicine">Medicine</option>
                                <option value="procedure">Procedure</option>
                                <option value="test">Test</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Item Name *</label>
                            <input type="text" id="invoiceItemName" required>
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" id="invoiceQuantity" value="1">
                        </div>
                        <div class="form-group">
                            <label>Unit Price (‚Çπ) *</label>
                            <input type="number" id="invoiceUnitPrice" step="0.01" required>
                        </div>
                    </div>
                    <button type="submit">Create Invoice</button>
                </form>
            </div>
            <div id="invoicesList" style="margin-top: 20px;"></div>
        </div>

        <!-- NAMASTE-ICD-11 Mapping Tab -->
        <div id="mapping" class="tab-content">
            <h2>NAMASTE-ICD-11 Mapping</h2>
            <div class="card">
                <h3>Search & Map Terms</h3>
                <div class="form-group">
                    <label>Enter NAMASTE/AYUSH Term</label>
                    <input type="text" id="mappingTerm" placeholder="e.g., Jwara, Kasa, Amlapitta"
                        onkeyup="if(event.key==='Enter') searchMapping()">
                </div>
                <button onclick="searchMapping()">Search & Get ICD-11 Suggestions</button>
                <div id="mappingResults" class="results"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const TOKEN = 'demo-token';

        let currentEncounterId = null;
        let currentPatientId = null;

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'patients') {
                loadPatients();
            } else if (tabName === 'appointments') {
                loadAppointments();
                loadPatientOptions('appointmentPatient');
            } else if (tabName === 'encounters') {
                loadPatientOptions('encounterPatient');
            } else if (tabName === 'prescriptions') {
                loadPatientOptions('prescriptionPatient');
            } else if (tabName === 'billing') {
                loadPatientOptions('invoicePatient');
                loadInvoices();
            }
        }

        // Dashboard
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/api/dashboard/stats`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const stats = await response.json();

                document.getElementById('dashboardStats').innerHTML = `
                    <div class="stat-card">
                        <h2>${stats.total_patients || 0}</h2>
                        <p>Total Patients</p>
                    </div>
                    <div class="stat-card">
                        <h2>${stats.today_appointments || 0}</h2>
                        <p>Today's Appointments</p>
                    </div>
                    <div class="stat-card">
                        <h2>${stats.today_encounters || 0}</h2>
                        <p>Today's Encounters</p>
                    </div>
                    <div class="stat-card">
                        <h2>‚Çπ${(stats.today_revenue || 0).toFixed(2)}</h2>
                        <p>Today's Revenue</p>
                    </div>
                `;

                document.getElementById('dashboardContent').innerHTML = `
                    <div class="card">
                        <h3>Quick Actions</h3>
                        <div class="grid">
                            <button onclick="showTab('patients'); event.target.blur();">Register Patient</button>
                            <button onclick="showTab('appointments'); event.target.blur();">Book Appointment</button>
                            <button onclick="showTab('encounters'); event.target.blur();">Start Encounter</button>
                            <button onclick="showTab('billing'); event.target.blur();">Create Invoice</button>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Patients
        async function registerPatient(e) {
            e.preventDefault();
            try {
                const response = await fetch(`${API_BASE}/api/patients`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${TOKEN}`
                    },
                    body: JSON.stringify({
                        name: document.getElementById('patientName').value,
                        age: parseInt(document.getElementById('patientAge').value) || null,
                        gender: document.getElementById('patientGender').value || null,
                        phone: document.getElementById('patientPhone').value || null,
                        email: document.getElementById('patientEmail').value || null,
                        abha_id: document.getElementById('patientAbha').value || null
                    })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('Patient registered successfully!');
                    document.getElementById('patientForm').reset();
                    loadPatients();
                }
            } catch (error) {
                alert('Error registering patient: ' + error.message);
            }
        }

        async function loadPatients() {
            try {
                const response = await fetch(`${API_BASE}/api/patients?limit=50`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const data = await response.json();
                displayPatients(data.patients || []);
            } catch (error) {
                console.error('Error loading patients:', error);
            }
        }

        async function searchPatients() {
            const query = document.getElementById('patientSearch').value;
            if (query.length < 2) {
                loadPatients();
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/api/patients?search=${encodeURIComponent(query)}`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const data = await response.json();
                displayPatients(data.patients || []);
            } catch (error) {
                console.error('Error searching patients:', error);
            }
        }

        function displayPatients(patients) {
            const html = patients.length > 0 ? `
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Age</th>
                            <th>Gender</th>
                            <th>Phone</th>
                            <th>ABHA ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${patients.map(p => `
                            <tr>
                                <td>${p.name}</td>
                                <td>${p.age || '-'}</td>
                                <td>${p.gender || '-'}</td>
                                <td>${p.phone || '-'}</td>
                                <td>${p.abha_id || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p>No patients found.</p>';
            document.getElementById('patientList').innerHTML = html;
        }

        async function loadPatientOptions(selectId) {
            try {
                const response = await fetch(`${API_BASE}/api/patients?limit=100`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const data = await response.json();
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select Patient</option>' +
                    (data.patients || []).map(p =>
                        `<option value="${p.id}">${p.name} ${p.phone ? '(' + p.phone + ')' : ''}</option>`
                    ).join('');
            } catch (error) {
                console.error('Error loading patients:', error);
            }
        }

        // Appointments
        async function bookAppointment(e) {
            e.preventDefault();
            try {
                const dateValue = document.getElementById('appointmentDate').value;
                const appointmentDate = new Date(dateValue).toISOString();

                const response = await fetch(`${API_BASE}/api/appointments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${TOKEN}`
                    },
                    body: JSON.stringify({
                        patient_id: document.getElementById('appointmentPatient').value,
                        staff_id: 'staff-001', // Demo staff ID
                        appointment_date: appointmentDate,
                        reason: document.getElementById('appointmentReason').value || null
                    })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('Appointment booked successfully!');
                    document.getElementById('appointmentForm').reset();
                    loadAppointments();
                }
            } catch (error) {
                alert('Error booking appointment: ' + error.message);
            }
        }

        async function loadAppointments() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`${API_BASE}/api/appointments?date_from=${today}&limit=20`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const data = await response.json();
                const html = data.appointments && data.appointments.length > 0 ? `
                    <table>
                        <thead>
                            <tr>
                                <th>Patient</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.appointments.map(a => `
                                <tr>
                                    <td>${a.patient_id}</td>
                                    <td>${new Date(a.appointment_date).toLocaleString()}</td>
                                    <td><span class="badge">${a.status}</span></td>
                                    <td>${a.reason || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p>No appointments found.</p>';
                document.getElementById('appointmentsList').innerHTML = html;
            } catch (error) {
                console.error('Error loading appointments:', error);
            }
        }

        // Encounters
        async function createEncounter(e) {
            e.preventDefault();
            try {
                const response = await fetch(`${API_BASE}/api/encounters`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${TOKEN}`
                    },
                    body: JSON.stringify({
                        patient_id: document.getElementById('encounterPatient').value,
                        staff_id: 'staff-001',
                        chief_complaint: document.getElementById('chiefComplaint').value || null
                    })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    currentEncounterId = result.encounter_id;
                    currentPatientId = document.getElementById('encounterPatient').value;
                    document.getElementById('encounterIdDisplay').textContent = result.encounter_id;
                    document.getElementById('encounterDetails').style.display = 'block';
                    alert('Encounter created! You can now add diagnoses and record vitals.');
                }
            } catch (error) {
                alert('Error creating encounter: ' + error.message);
            }
        }

        async function recordVitals() {
            if (!currentEncounterId) {
                alert('Please create an encounter first');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/api/encounters/${currentEncounterId}/vitals`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${TOKEN}`
                    },
                    body: JSON.stringify({
                        temperature: parseFloat(document.getElementById('vitalTemp').value) || null,
                        blood_pressure_systolic: parseInt(document.getElementById('vitalBP1').value) || null,
                        blood_pressure_diastolic: parseInt(document.getElementById('vitalBP2').value) || null,
                        pulse: parseInt(document.getElementById('vitalPulse').value) || null,
                        weight: parseFloat(document.getElementById('vitalWeight').value) || null,
                        height: parseFloat(document.getElementById('vitalHeight').value) || null
                    })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('Vital signs recorded successfully!');
                    // Clear form
                    ['vitalTemp', 'vitalBP1', 'vitalBP2', 'vitalPulse', 'vitalWeight', 'vitalHeight'].forEach(id => {
                        document.getElementById(id).value = '';
                    });
                }
            } catch (error) {
                alert('Error recording vitals: ' + error.message);
            }
        }

        async function suggestDiagnosis() {
            if (!currentEncounterId) {
                alert('Please create an encounter first');
                return;
            }
            const term = document.getElementById('namasteTerm').value;
            if (!term) {
                alert('Please enter a NAMASTE term');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/api/encounters/${currentEncounterId}/suggest-diagnosis?term=${encodeURIComponent(term)}&k=3`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const data = await response.json();
                displayDiagnosisSuggestions(data.suggestions || []);
            } catch (error) {
                alert('Error getting suggestions: ' + error.message);
            }
        }

        function displayDiagnosisSuggestions(suggestions) {
            const html = suggestions.length > 0 ? `
                <div class="card" style="margin-top: 15px;">
                    <h4>ICD-11 Suggestions:</h4>
                    ${suggestions.map((s, idx) => `
                        <div class="diagnosis-item">
                            <strong>${s.icd_code}</strong> - ${s.icd_title || 'N/A'}
                            <br><small>Confidence: ${(s.confidence * 100).toFixed(1)}%</small>
                            <button onclick="addDiagnosis('${s.icd_code}', '${document.getElementById('namasteTerm').value}')" style="float: right; margin-top: 5px;">Add Diagnosis</button>
                        </div>
                    `).join('')}
                </div>
            ` : '<p>No suggestions found.</p>';
            document.getElementById('diagnosisSuggestions').innerHTML = html;
        }

        async function addDiagnosis(icdCode, ayushTerm) {
            if (!currentEncounterId) {
                alert('Please create an encounter first');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/api/encounters/${currentEncounterId}/diagnosis`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${TOKEN}`
                    },
                    body: JSON.stringify({
                        ayush_term: ayushTerm,
                        icd_code: icdCode,
                        diagnosis_type: 'primary'
                    })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('Diagnosis added successfully!');
                    document.getElementById('namasteTerm').value = '';
                    document.getElementById('diagnosisSuggestions').innerHTML = '';
                    loadEncounterDiagnoses();
                }
            } catch (error) {
                alert('Error adding diagnosis: ' + error.message);
            }
        }

        async function loadEncounterDiagnoses() {
            if (!currentEncounterId) return;
            try {
                const response = await fetch(`${API_BASE}/api/encounters/${currentEncounterId}`, {
                    headers: { 'Authorization': `Bearer ${TOKEN}` }
                });
                const data = await response.json();
                const html = data.diagnoses && data.diagnoses.length > 0 ? `
                    <h4>Current Diagnoses:</h4>
                    ${data.diagnoses.map(d => `
                        <div class="diagnosis-item">
                            <strong>ICD-11:</strong> ${d.icd_code} | <strong>Type:</strong> ${d.diagnosis_type}
                        </div>
                    `).join('')}
                ` : '<p>No diagnoses added yet.</p>';
                document.getElementById('encounterDiagnoses').innerHTML = html;
            } catch (error) {
                console.error('Error loading diagnoses:', error);
            }
        }

        // Prescriptions
        async function createPrescription(e) {
            e.preventDefault();
            if (!currentEncounterId) {
                alert('Please create an encounter first');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/api/prescriptions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${TOKEN}`
                    },
                    body: JSON.stringify({
                        encounter_id: currentEncounterId,
                        patient_id: currentPatientId || document.getElementById('prescriptionPatient').value,
                        staff_id: 'staff-001',
                        items: [{
                            medicine_name: document.getElementById('medicineName').value,
                            dosage: document.getElementById('medicineDosage').value || null,
                            frequency: document.getElementById('medicineFrequency').value || null,
                            duration: document.getElementById('medicineDuration').value || null,
                            quantity: parseInt(document.getElementById('medicineQuantity').value) || null
                        }]
                    })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert('Prescription created successfully!');
                    document.getElementById('prescriptionForm').reset();
                }
            } catch (error) {
                alert('Error creating prescription: ' + error.message);
            }
        }

        // Billing
        async function createInvoice(e) {
            e.preventDefault();
            try {
                const response = await fetch(`${API_BASE}/api/billing/invoices`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${TOKEN}`
                    },
                    body: JSON.stringify({
                        patient_id: document.getElementById('invoicePatient').value,
                        encounter_id: currentEncounterId || null,
                        items: [{
                            item_type: document.getElementById('invoiceItemType').value,
                            item_name: document.getElementById('invoiceItemName').value,
                            quantity: parseInt(document.getElementById('invoiceQuantity').value) || 1,
                            unit_price: parseFloat(document.getElementById('invoiceUnitPrice').value)
                        }]
                    })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    alert(`Invoice created! Invoice #: ${result.invoice_number}, Total: ‚Çπ${result.total}`);
                    document.getElementById('invoiceForm').reset();
                    loadInvoices();
                }
            } catch (error) {
                alert('Error creating invoice: ' + error.message);
            }
        }

        async function loadInvoices() {
            // This would load recent invoices - simplified for demo
            document.getElementById('invoicesList').innerHTML = '<p>Invoice list will be displayed here.</p>';
        }

        // NAMASTE-ICD-11 Mapping
        async function searchMapping() {
            const term = document.getElementById('mappingTerm').value;
            if (!term) {
                alert('Please enter a term');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/api/suggest`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${TOKEN}`
                    },
                    body: JSON.stringify({ term, k: 5 })
                });
                const data = await response.json();
                displayMappingResults(data.data || {});
            } catch (error) {
                alert('Error searching: ' + error.message);
            }
        }

        function displayMappingResults(data) {
            const results = data.results || [];
            const html = results.length > 0 ? `
                <div class="card" style="margin-top: 15px;">
                    <h4>Mapping Results (${data.type || 'unknown'}):</h4>
                    ${results.map(r => `
                        <div class="result-item">
                            <h4>${r.icd_code} - ${r.icd_title || 'N/A'}</h4>
                            <p>Confidence: ${(r.confidence * 100).toFixed(1)}%</p>
                        </div>
                    `).join('')}
                </div>
            ` : '<p>No results found.</p>';
            document.getElementById('mappingResults').innerHTML = html;
        }

        // Initialize
        window.onload = function () {
            loadDashboard();
            loadPatients();
        };
    </script>
</body>

</html>